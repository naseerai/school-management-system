name: ğŸš€ Deploy School Management App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ SSH into Server and Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            PROJECTS_DIR="/root/projects"
            PROJECT_NAME="school-management"
            PROJECT_PATH="$PROJECTS_DIR/$PROJECT_NAME"

            echo "ğŸ” Checking if project exists..."
            if [ ! -d "$PROJECT_PATH" ]; then
              echo "ğŸ“¦ Cloning repository..."
              mkdir -p "$PROJECTS_DIR"
              cd "$PROJECTS_DIR"
              git clone https://github.com/kovvurisuryavenkatareddy/school-management.git "$PROJECT_NAME"
            else
              echo "ğŸ” Pulling latest code..."
              cd "$PROJECT_PATH"
              git fetch origin main
              git reset --hard origin/main
            fi

            echo "âš™ï¸ Copying environment file..."
            cd "$PROJECT_PATH"
            cp .env.example .env

            echo "ğŸ§¹ Removing old containers..."
            docker compose down || true

            echo "ğŸ—‘ï¸ Removing old image..."
            docker image prune -f

            echo "ğŸš€ Starting containers..."
            docker compose up -d --build

            echo "âœ… Deployment complete!"
